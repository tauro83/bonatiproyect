<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="779" height="466" title="Registrar Usuario" borderColor="#15AD8F" >
	<mx:Script>
		<![CDATA[   
		
			//=======================================================================
			// FECHA: CREACIÓN: 05/08/09   
			// AUTOR: Camilo Verdugo      
			// Comentarios: Formulario y validacion del registro de un usuario de sistema 
			//=======================================================================
			import util.Properties;
			import mx.events.FlexMouseEvent;
			import mx.controls.Text;
			import mx.controls.Alert;
			import mx.rpc.events.ResultEvent;
			import services.UsuarioService;
			import services.Validacion;
			import transferObjects.Usuario;
			import mx.core.Application;
			import services.Mensajes;
			import services.configuracionServices;
			import mx.collections.ArrayCollection;   
			private var vUsuario:Boolean;
			private var vNombre:Boolean;
			private var vContrasena:Boolean;
			private var vRContrasena:Boolean;
			private var vApaterno:Boolean;
			private var ru:UsuarioService = new UsuarioService();
			private var u1:Usuario;
			[Bindable]private var cargos:ArrayCollection;
			private var confs:configuracionServices= new configuracionServices();
			[Bindable]private var servicios:ArrayCollection;
			
			
			public function iniciar():void
			{
				this.cargarDatosSer();
				this.cargarDatos();
			}
			
			/** 
			 *  Obtiene las especies desde el actionScript
		 	 * 	@author  "Camilo Verdugo"
			 * */	 
			 
			public function cargarDatosSer():void
			{
				confs.getConfiguraciones("Servicio");
				confs.addEventListener(ResultEvent.RESULT,cargarDatosSerR);
			}
			
			/** 
			 *  Asigna el retorno del llamado de cargarDatos a un
			 *   arrayCollection para mostrar las configuraciones
		 	 * 	@author  "Camilo Verdugo"
			 * */
			public function cargarDatosSerR(event:ResultEvent):void
			{
				servicios = event.result as ArrayCollection;
			}
			
			/** 
			 *  Metodo que crea una instancia del transferObject usuario,
			 *  posterior a la validacion de datos  y lo envia a usuarioServices	
		 	 * 	@author  "Camilo Verdugo"
			 * 	@Fecha  23 Septiembre
			 * */
			private function registrar():void
			{								 
				if(vNombre==true)
				{
					if(vApaterno==true)
					{
					
						if(vUsuario==true)
						{
							
							if(vRContrasena==true)
							{
								if(vContrasena==true)
								{
									u1					= new Usuario();
									u1.nombre 			= nomb.text;
									u1.apellidoMaterno 	= amat.text;
									u1.apellidoPaterno 	= apat.text;
									u1.cargo			= carg.selectedLabel;
									u1.contrasena		= cont.text;
									u1.nombre			= nomb.text;
									u1.permisoEditar	= pedi.selected;
									u1.permisoEliminar	= peli.selected;
									u1.permisoPurgar	= ppur.selected;
									u1.permisoRegistrar	= preg.selected;
									u1.servicio			= serv.selectedLabel;
									u1.usuario			= usua.text;						
												
									
									ru.regUsuario(u1,Application.application.login2.usuarioActivo);				
									ru.addEventListener(ResultEvent.RESULT,registroUsuarioResultado);	
								}
								else{
										mens.text = Properties.getMensaje("Advertencia", "12");
								}
							}
							else{
								mens.text =  Properties.getMensaje("Advertencia", "9");
							}
							
						}
						else{
							mens.text =  Properties.getMensaje("Advertencia", "8");
						}
					}
					else{
						mens.text = Properties.getMensaje("Advertencia", "6");
					}																				
				}
				else
				{
					mens.text =  Properties.getMensaje("Advertencia", "4");
					//mens.text = Properties.getMensaje("Error", "7");
					//"Corrija los datos antes de registrar";
				}			
			}
			
			
			/** 
			 *  Obtiene las especies desde el actionScript
		 	 * 	@author  "Camilo Verdugo"
			 * */
			public function cargarDatos():void
			{	
				var confs2:configuracionServices= new configuracionServices();
				confs2.getConfiguraciones("Cargo");
				confs2.addEventListener(ResultEvent.RESULT,cargarDatosCargosR);
			}
			
			/** 
			 *  Asigna el retorno del llamado de cargarDatos a un arrayCollection para mostrar las configuraciones
		 	 * 	@author  "Camilo Verdugo"
			 * */
			public function cargarDatosCargosR(event:ResultEvent):void
			{
				cargos = event.result as ArrayCollection;
			}
			
			/** 
			 *  Metodo que reinicia los campos de textos, tras una accion de cancelar
			 * 	o regitrar satisfactoriamente a un usuario.
		 	 * 	@author  "Camilo Verdugo"
			 * */
			public function resetVars():void
			{				
				nomb.text 		= "";
				amat.text 		= "";
				apat.text		= "";					
				cont.text 		= "";
				nomb.text 		= "";
				pedi.selected 	= false;
				peli.selected 	= false;
				ppur.selected 	= false;
				preg.selected	= false;
				ptod.selected 	= false;
				usua.text 		= "";	
				rcon.text 		= "";			
				vNombre 		= false;
				vUsuario 		= false;
				vContrasena 	= false;
				vRContrasena 	= false;
				vApaterno		= false;
				mens.text		= "";				
			}
			/** 
			 *  Metodo que reinicia los campos de textos, tras una accion de cancelar
			 * 	o regitrar satisfactoriamente a un usuario.
		 	 * 	@author  "Camilo Verdugo"
			 * */
			public function resetVars2():void
			{
				nomb.text 		= "";
				amat.text 		= "";
				apat.text		= "";					
				cont.text 		= "";
				nomb.text 		= "";
				pedi.selected 	= false;
				peli.selected 	= false;
				ppur.selected 	= false;
				preg.selected	= false;
				ptod.selected 	= false;
				usua.text 		= "";	
				rcon.text 		= "";			
				vNombre 		= false;
				vUsuario 		= false;
				vContrasena 	= false;
				vRContrasena 	= false;
				vApaterno		= false;
				mens.text		= "";			
				this.cancelarRegistrar();
			}
			/** 
			 *  Validacion del nombre del usuario	 
		 	 * 	@author  "Camilo Verdugo"
			 * 	@Fecha  23 Septiembre
			 * */
			private function validarNombre(event:Event):void
			{
				if(nomb.length>3)
				{
					vNombre		= true;
					mens.text = "";
				}
				else
				{
					vNombre		= false;
					mens.text =  Properties.getMensaje("Advertencia", "4");
					//"Ingrese un nombre más largo";
				}	
			}
			
			/** 
			 *  Validacion del nombre con el cual el usuario se identificara en el sistema
		 	 * 	@author  "Camilo Verdugo"
			 * */
			private function validarUsuario(event:Event):void
			{	
				if(usua.length>3 && usua.text.search(" ")==-1)
				{
					vUsuario	= true;		
					mens.text = "";	
				}
				else
				{
					vUsuario	= false;
					mens.text =  Properties.getMensaje("Advertencia", "8");
					//"Ingrese un nombre de usuario más largo";
				}
				
			}
			
			/** 
			 *  Validacion las propiedades de la contraseña	
		 	 * 	@author  "Camilo Verdugo"
			 * */
			private function validarContrasena(event:Event):void
			{
				if(cont.length>3)
				{
					vContrasena	= true;	
					mens.text = "";	
				}
				else
				{
					vContrasena	= false;
					mens.text = Properties.getMensaje("Advertencia", "12");
					//"Ingrese una contraseña sin espacios en blanco y más larga";
				}	
				
			}
			
			/** 
			 *  Comprueba que las dos contraseñas ingresadas coincidan	
		 	 * 	@author  "Camilo Verdugo"
			 * */
			private function validarRContrasena(event:Event):void
			{
				if(cont.text == rcon.text)
				{
					vRContrasena = true;	
					mens.text = "";			
				}
				else
				{
					vRContrasena = false;	
					mens.text =  Properties.getMensaje("Advertencia", "9");
					//"Ingrese una contraseña que coincida con la anterior"		
				}
			}
			
			/** 
			 *  Realiza la opcion de elegir todos los privilegios tras seleccionar la opcion todos
		 	 * 	@author  "Camilo Verdugo"
			 * */
			private function todosLosPrivilegios(event:Event):void
			{
				if(ptod.selected == true)
				{
					pedi.selected = true;
					peli.selected = true;
					ppur.selected = true;
					preg.selected = true;
				}
				else{
					pedi.selected = false;
					peli.selected = false;
					ppur.selected = false;
					preg.selected = false;
				}
			}			
			
			/** 
			 *  Inicia los eventos de las entradas de texto que requieren revision
		 	 * 	@author  "Camilo Verdugo"
			 * */
			private function iniListener():void
			{
				nomb.addEventListener(KeyboardEvent.KEY_UP,validarNombre);
				cont.addEventListener(KeyboardEvent.KEY_UP,validarContrasena);
				rcon.addEventListener(KeyboardEvent.KEY_UP,validarRContrasena);
				usua.addEventListener(KeyboardEvent.KEY_UP,validarUsuario);		
				ptod.addEventListener(MouseEvent.CLICK,todosLosPrivilegios);
				apat.addEventListener(KeyboardEvent.KEY_UP,validarApellido);
			}

			private function validarApellido(event:Event):void
			{
				if(apat.length>3)
				{
					vApaterno = true;	
					mens.text = "";			
				}
				else
				{
					vApaterno = false;	
					mens.text = Properties.getMensaje("Advertencia", "6");
					//"Ingrese un apellido paterno más largo";			
				}
			}
			
			
			/** 
			 *  Retorna el resultado de la accion que se realizo:Registro.
		 	 * 	@author  "Camilo Verdugo"
			 * */
			private function registroUsuarioResultado(event:ResultEvent):void
			{
				var message:String= event.result as String;	
				var msj:String = "";
				if(message=="1"){
					msj = Properties.getMensaje("Informacion", "5");
					//Se ha registrado el usuario
				 	resetVars(); 					
    		 	}
				else{
					msj = Properties.getMensaje("Error", "18");
					//"Usuario previamente registrado, elija otro nombre de usuario";			
				}		
				mens.text = msj;	
			}	
			/** 
			 *  Retorna el panel anterior de opciones	
		 	 * 	@author  "Camilo Verdugo"
			 * */
			private function cancelarRegistrar():void
			{
				Application.application.setInvisible();
            	Application.application.panel2.setVisible(true,false);
            	Application.application.AdmOpciones1.setVisible(true,false);
			}
				
		]]>
	</mx:Script> 
	<mx:Button xmlns:mx="http://www.adobe.com/2006/mxml" width="102" height="25" x="632" label="Cancelar" click="resetVars2()" y="353"/>
	<mx:Button xmlns:mx="http://www.adobe.com/2006/mxml" width="102" height="25" x="522" label="Registrar" click="registrar()" y="353"/>
	<mx:TextInput x="155" y="8" width="163" restrict="A-Z a-z ñ Ñ Á É Í Ó Ú á é í ó ú" includeInLayout="true" id="nomb"  click="iniListener()" enabled="true" maxChars="20"/>
	<mx:TextInput x="155" y="48" width="163" restrict="A-Z a-z ñ Ñ Á É Í Ó Ú á é í ó ú" id="apat" enabled="true" maxChars="20"/>	
	<mx:TextInput x="554" y="48" id="amat" restrict="A-Z a-z ñ Ñ Á É Í Ó Ú á é í ó ú" enabled="true" maxChars="20" width="181"/>
	<mx:TextInput x="155" y="93" id="usua"  restrict="A-Z a-z ñ Ñ" enabled="true" click="iniListener()" maxChars="20" width="163"/>
	
	<mx:ComboBox x="155" y="135" id="carg" dataProvider="{cargos}" labelField="nombre" width="163"/>
	
	<mx:TextInput x="155" y="180"  displayAsPassword="true" editable="true" width="160" enabled="true"  id="cont" click="iniListener()" maxChars="20"/>
	<mx:TextInput x="554" y="180" displayAsPassword="true" width="181" enabled="true" id="rcon"  click="iniListener()" maxChars="20"/>
 	
 	<mx:ComboBox x="152" y="221" id="serv" width="163" dataProvider="{servicios}"  labelField="nombre"/>	
 	
	<mx:Label x="25" y="182" text="Contraseña:" textAlign="left"/>
	<mx:Label x="25" y="95" text="Usuario:" textAlign="left"/>
	<mx:Label x="25" y="50" text="Apellido paterno:" height="20"/>
	<mx:Label x="424" y="50" text="Apellido materno:" height="20"/>
	<mx:Label x="25" y="10" text="Nombre:" width="69" />
	<mx:Label x="25" y="137" text="Cargo:"/>
	<mx:Label x="25" y="223" text="Servicio:" textAlign="left"/>
	<mx:Label x="25" y="269" text="Permisos:"/>
	<mx:Label x="424" y="182" text="Repetir contraseña:"/>	
	<mx:CheckBox x="152" y="267" label="Registrar" id="preg"/>
	<mx:CheckBox x="250" y="267" label="Editar" id="pedi"/>
	<mx:CheckBox x="345" y="267" label="Eliminar" id="peli"/>
	<mx:CheckBox x="468" y="267" label="Purgar" id="ppur"/>
	<mx:CheckBox x="554" y="267" label="Todos" id="ptod" click="iniListener()"/>
	<mx:Label x="176" y="399" width="407" height="17" id="mens" fontWeight="bold" textAlign="center"/>
</mx:Panel>
