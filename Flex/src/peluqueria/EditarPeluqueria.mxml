
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="779" height="466" borderColor="#15AD8F" xmlns:fc="http://www.adobe.com/2006/fc" title="Visualizar Registros Atención Peluquería" xmlns:ns1="util.*">
	
	<mx:Script>
        <![CDATA[
        	import mx.controls.Text;
        	import transferObjects.Usuario;
        
        	//=======================================================================
			// FECHA: CREACIÓN: 11/11/09
			// AUTOR: Raul Lopez
			// Formulario para obtener datos del cliente y sus mascotas.
			//=======================================================================
			
        	import mx.events.CollectionEvent;
        	import transferObjects.Mascota;
        	import transferObjects.Consulta;
        	import services.AddConsultaService;
        	import transferObjects.ConfiguracionVacuna;
        	import transferObjects.Cliente;
        	import services.AddMascotaService;
        	import mx.controls.DateField;
        	import mx.controls.Alert;
            import mx.collections.ArrayCollection;
        	import mx.controls.Alert;
			import mx.events.CloseEvent;
			import mx.events.ValidationResultEvent;            
  			import flash.display.Sprite;
		    import flash.events.*;
		    import flash.net.FileReference;
		    import flash.net.FileReferenceList;
		    import mx.rpc.events.ResultEvent;
			import mx.controls.Image;
		    import mx.core.Application;
		    import transferObjects.Person;
		    import pabellon.addCirugia;
		    import pabellon.addCirugia1;
		    import pabellon.AddCirugiaService;
		    import Policlinico.AddVacunacion;
		    import services.BusquedaService;
		    import services.configuracionServices;
		    import pabellon.EditCirugiaService;
		    import pabellon.EditarConsultaService;
		    import transferObjects.Peluqueria;
			import services.GetCatalogos;
			import transferObjects.CatPeluqueria;
			import peluqueria.EditarPeluqueriaUpdate;
			import services.AddMascotaService;
			
			[Bindable]
			private var files:ArrayCollection=new ArrayCollection();
		    private var vResult:ValidationResultEvent;
		    public var clienteBD:Cliente;
		    [Bindable]
		    public var tiposV:ArrayCollection;
		    [Bindable]
		    public var vetesV:ArrayCollection;
		    [Bindable]
		    public var ayudantesV:ArrayCollection;
		    [Bindable]
			private var clientes:ArrayCollection;
			[Bindable]
			private var cliente2:ArrayCollection;
			
			//editando para cargar las consultas
			[Bindable]
			private var peluquerias:ArrayCollection = new ArrayCollection();
			
		    [Bindable]
			private var consultas2:ArrayCollection;
			
		    /**
			* Lista de Mascotas del cliente asociado
			*/
		    [Bindable] 
		    public var mascotas:ArrayCollection = new ArrayCollection();
		    [Bindable] 
		    public var mascotas2:ArrayCollection = new ArrayCollection();
		    
		    [Bindable] 
		    public var cliente:Person;
		      
		   [Bindable]private var vacunas:ArrayCollection;
			private var confs:configuracionServices= new configuracionServices();
			
			[Bindable]
			public var newCPeluqueria:Peluqueria;
			[Bindable]private var listCatalogosP:ArrayCollection;
			[Bindable]private var listCatP:ArrayCollection;
			[Bindable]
			public var edita:Boolean;
			[Bindable]
			public var peluqueros:ArrayCollection;
			
			
			/** 
         	 *  Metodo que obtiene todas los items del catalogo
         	 *  Los cuales seran utilizados para seleccionarlos y luego editarlos.
         	 * @author  "Raul Lopez"
			 * */
			public function getAllCatalogo():void
			{	
				var getCatServices:GetCatalogos = new GetCatalogos();
				getCatServices.getCatalogo();
				getCatServices.addEventListener(ResultEvent.RESULT,getAllCatalogoR);							
			}
			/**
			 *  Metodo que asigna el retorno del metodo anterior a una lista la cual sera cargada en
			 *  el grid.
			 * 	@author  "Raul Lopez"
			 * */
			public function getAllCatalogoR(event:ResultEvent):void
			{				
				listCatalogosP = event.result as ArrayCollection;	
				concatenaCatP();
			}
			
			/**
			* Metodo que concatena el apellido paterno, con el apellido materno, y el nombre, para mostrarlo 
			* en el autocomplete, para buscar al cliente por el apellido.
		 	* 	@author  "Raul Lopez"
			*/
		   private function concatenaCatP():void
		   {
		   		
		   		var i:int;
		   		var max:int = listCatalogosP.length;
		   		var catalog:CatPeluqueria;
		   		var catalog2:CatPeluqueria;
		   		
		   		for(i=0;i<max;i++){
		   			catalog= listCatalogosP.getItemAt(i,0) as CatPeluqueria;
		   			catalog2 = new CatPeluqueria();
		   			var nombre:String = "";
		   			var nombres:Array = catalog.nombre.split(" ",10);
		   			var inombre:int;
		   			var mas:int = nombres.length;
		   			for(inombre = 0;inombre<mas;inombre++){
		   				var ns:String = nombres.pop();
		   				if(ns != ""){
		   					nombre = ns.concat(" "+nombre);
		   				}
		   				
		   			}		   			
		   			catalog2.nombre = ""+catalog.servicio.split(" ",1).pop()+" "+nombre;
		   			listCatP.addItem(catalog2);
		   		}
		   		
		   }
			
			
			/** 
			 * Funcion que busca un cliente, en la base de datos, para esto primero verifica 
			 * si el rut esta ingresado correctamente, en caso de estar incorrecto lo informa por pantalla.
			 * En caso contrario realiza las llamadas a la capa de java, la cual procesara la soliitud, y 
			 * retornara si el cliente existe o no.
		 	 * 	@author  "Raul Lopez"
			 * @param event Evento
			 */
        	private function buscarCliente(event:Event):void{
        		if(nombreRutIn.rutClienteDVInput.text != "" && nombreRutIn.rutClienteInput.text != ""){
        			var Numero:String = nombreRutIn.rutClienteInput.text;
        			var Dv:String = nombreRutIn.rutClienteDVInput.text;
					var suma:int = 0;
					var rut:String = Numero;
					var NumMag:int = 2;
					var Resto:int = 0;
					var j:int ;
					var i:int;
					var DigVer:Array = new Array("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "K", "0");
					var ParteNumerica:Array = new Array();
				
					if (rut.length == 0) { 

					}
					for ( j =0, i =0; j < rut.length; j++){
						if (rut.charAt(j) != ' ' && rut.charAt(j) != '.' && rut.charAt(j) != '-'){
							ParteNumerica[i] = rut.charAt(i);
							++i;
						}
					}
				
					for (i=ParteNumerica.length-1; i>=0; i--, NumMag++){
						suma += ParteNumerica[i] * NumMag;
						trace(suma +' '+ ParteNumerica[i] +' '+ NumMag);
						if (NumMag>6){
							NumMag =1;	
						}	
					}
					
					Resto = 11-(suma%11);
					if(DigVer[Resto] != Dv.toUpperCase()){
						labelMessage.text = "El Rut que ha ingresado es incorrecto.";
					}
					else{
						labelMessage.text = "";
						nombreRutIn.rutClienteInput.errorString = "";
						getCliente(nombreRutIn.rutClienteInput.text);
					}
        		}		
        	}
        	
        	/**
			 * Metod que gestiona la comunicacion con la capa logica, a traves del servicio AddCirugiaService
			 * el cual envia las solicitudes, y devuelve los resultados.
		 	 * 	@author Raul Lopez
			 */
        	private function getCliente(rutCliente:String):void{
				var addConsultaService:AddConsultaService = new AddConsultaService();
				addConsultaService.addEventListener(ResultEvent.RESULT,getClienteResult);
				addConsultaService.getCliente(rutCliente);
			}
			
			
			/**
			 * Metod que gestiona la comunicacion con la capa logica, a traves del servicio AddCirugiaService
			 * el cual envia las solicitudes, y devuelve los resultados. Se procesa el resultado del metodo 
			 * anterior.
		 	 * 	@author Raul Lopez
			 * @param event Evento
			 */
			public function getClienteResult(event:ResultEvent):void{
				clienteBD = event.result as Cliente;
				
				if(clienteBD.nombre == null){
        			labelMessage.text = "Cliente no registrado."
        			
        		}
        		else{
        			this.nombreRutIn.inputClienteNombre.text = clienteBD.nombre;
        			labelMessage.text = "Se ha accedido al cliente "+clienteBD.nombre;
        			ini();
        			
        		}
			}
			
			/**
			 * Metodo que se comunica con la capa logica, para obtener un listado con los nombres de los 
			 * veterinarios esto lo hace a traves de la clase AddVacunacionService. 
		 	 * @author  "Raul Lopez"
			 */
			private function getTiposVeterinarios():void
			{
				var addpelService:AddPeluqueriaService = new AddPeluqueriaService();
				addpelService.addEventListener(ResultEvent.RESULT,getTiposV);
				addpelService.getTiposPeluqueros();
			}
			
			/**
			 * Metodo que procesa el resultado del metodo anterior, almacenando la lista resultante en la 
			 * variable vetesC. Que corresponde a la lista veterinarios que existen en el sistema.
		 	 * @author  "Raul Lopez"
			 * @param event Evento
			 */
			private function getTiposV(event:ResultEvent):void
			{
				vetesV = event.result as ArrayCollection;
			}
        	
			/**
			* Funcion que llena la tabla de mascotas asociadas al cliente, despues de haber obtenido el resultado
			* de la comunicacion con la capa logica.
		 	* 	@author  "Raul Lopez"
			* @param event Evento
			*/
	        private function ini():void{
	           	mascotas.removeAll();
	           	getMascotas();
				mascotas.refresh();
	        }
	         
        	
        					
					
			/**
			 * Metodo que realiza la comunicacion a la capa logica a traves de AddVacunaService,
			 * solicitando todas las mascotas que le pertenescan a un determinado cliente.
		 	 * 	@author  "Raul Lopez"
			 */
			private function getMascotas():void{
				var addpelService:AddMascotaService = new AddMascotaService();
				addpelService.addEventListener(ResultEvent.RESULT,getAddMascotasResult);
				addpelService.getMascotas(nombreRutIn.rutClienteInput.text+nombreRutIn.rutClienteDVInput.text);
			}
			
			/**
			 * Metodo que realiza la comunicacion a la capa logica a traves de AddVacunacionService,
			 * solicitando todas las mascotas que le pertenescan a un determinado cliente. 
			 * Se almacena el resultado del metodo anterior en la variable mascotas.
		 	 * @author  "Raul Lopez"
			 * @param event Evento
			 */
			private function getAddMascotasResult(event:ResultEvent):void{
				var newMasc:Mascota = new Mascota();
				newMasc.nombre = "";


				mascotas2 = event.result as ArrayCollection;
				mascotas2.addItemAt(newMasc,0);
				mascotas = mascotas2;
				
			}	        
	        
	        /**
	        * Metodo que procesa si solicita, a la base de datos, los datos de atenciones de peluqueria 
	        * existentes, asociadas a una mascota. Para esto se verifica si el usuario selecciono un mascota
	        * de la lista, si se eligio una, se realiza la consulta, si no, se le pide que seleccione una.
	        * @author "Raul Lopez"
	        */
	       	public function busca():void{
	       		if(dg2.selectedLabel!=""){
	       			this.labelMessage.text="";
	       			var nombre:String = dg2.selectedLabel
	       			
	       			getPeluquerias(nombre,nombreRutIn.rutClienteInput.text+nombreRutIn.rutClienteDVInput.text);
	       		}
	       		else{
	       			this.labelMessage.text="Seleccione una mascota, para ver sus atenciones.";
	       			this.peluquerias = new ArrayCollection();
	       		}
	       	}  
			
			/**
	        * Metodo que se comunica con EditarPeluService, para obtener los datos de las atenciones 
	        * registradas, enviandole los respectivos datos para obtener dichos datos.
	        * @author "Raul Lopez"
	        */
			public function getPeluquerias(nombreMasc:String, rut:String):void{
				
				var edPeluqService:EditarPeluService = new EditarPeluService();
				edPeluqService.addEventListener(ResultEvent.RESULT,getPeluqueriasResult);
				edPeluqService.getAllPeluquerias(nombreMasc,rut);
			}
			
			 /**
	        * Metodo en el cual se almacena el resultado del metodo anterior, en el ArrayCollection, 
	        * que representa las atenciones de la mascota.
	        * @author "Raul Lopez"
	        */
			public function getPeluqueriasResult(event:ResultEvent):void{
				
				peluquerias = event.result as ArrayCollection;				
				
			}			
			
			
			/**
			* Metodo que inicializa todos los valores y variables de este panel.
			 * @author  Raul Lopez
			*/
			public function iniciarPanel():void
			{
				this.edita = false;
				this.listCatP = new ArrayCollection();
				this.listCatalogosP = new ArrayCollection();	
				peluquerias = new ArrayCollection();
				cliente2 = new ArrayCollection();
				clientes = new ArrayCollection();
				nombreRutIn.inputClienteNombre.typedText = "";
				nombreRutIn.inputClienteNombre.text = "";
				this.edita = true;
				this.mascotas=new ArrayCollection();
				this.mascotas2=new ArrayCollection();
				this.Tabla.doubleClickEnabled=true;
				this.labelMessage.text="";
				this.nombreRutIn.rutClienteInput.text="";
				this.nombreRutIn.rutClienteDVInput.text="";
				this.nombreRutIn.inputClienteNombre.text="";
				this.getTiposVeterinarios();
				this.getAllCatalogo();
				this.getResp();
			}
			
			/**
			 * Metodo que inicializa los valores de los tipos de vacunas, veterinarios y ayudantes.
		 	 * 	@author  "Jimmy Muñoz"
			 */
			public function iniciarPanel1():void
			{
				this.getTiposVeterinarios();
				this.getResp();
			}
			
			/**
			 * Metodo que inicializa los valores de los clientes del sistema, para seleccionarlo 
			 * ingresando su apellido. Llamando a la funcion de BusquedaService.
		 	 * 	@author  "Raul Lopez"
			 */
		   public function getAllClientes():void
		   {
		   		if(edita){
		   			this.labelMessage.text="";
		   			var busquedaService:BusquedaService = new BusquedaService();
		   			busquedaService.addEventListener(ResultEvent.RESULT,getAllClientesResult);
					busquedaService.getAllClientes();
					this.edita=false;
		   		}
		   }
		   
		   /**
			* Metodo que almacena el resultado del metodo anterior en el arraycollection cliente2.
			* Y llama a la funcion concatena.
			 * @author  Raul Lopez
			*/
		   public function getAllClientesResult(event:ResultEvent):void
		   {
		   		cliente2 = event.result as ArrayCollection;
		   		
		   		concatena();
		   }
		   
		   /**
			* Metodo que concatena el apellido paterno, con el apellido materno, y el nombre, para mostrarlo 
			* en el autocomplete, para buscar al cliente por el apellido.
			*   @author  Raul Lopez
			*/
		   public function concatena():void
		   {
		   		var i:int;
		   		var max:int = cliente2.length;
		   		
		   		for(i=0;i<max;i++){
		   			var cli:Cliente = cliente2.getItemAt(i,0) as Cliente;
		   			var cli2:Cliente = new Cliente();
		   			cli2.nombre = ""+cli.apellido+" "+cli.apellido2+" "+cli.nombre;
		   			clientes.addItem(cli2);
		   		}
		   }
		   
		   /**
			* Metodo que busca al cliente, al momento de soltar el autocomplete del apellido, 
			 * procesando los datos, partiendo el texto, y guardandolo en el nombreN, apellidomN
			 * y en apellidopN.
			 * @author  Raul Lopez
			 */
		   public function buscarCliente2():void
		   {
		   		this.labelMessage.text="";
		   		var nombre:String = nombreRutIn.inputClienteNombre.text;
		   		if(nombreRutIn.inputClienteNombre.text != "" || nombreRutIn.inputClienteNombre.selectedLabel != ""){
		   			var largo:int = cliente2.length;
		   			var i:int;
		   			var sss:Array;
		   			if(nombreRutIn.inputClienteNombre.selectedLabel != ""){
		   				sss = nombreRutIn.inputClienteNombre.selectedLabel.split(" ",3);
		   			}
		   			else{
		   				sss = nombreRutIn.inputClienteNombre.text.split(" ",3);
		   			}
		   			
		   			/**
		   			 * obtiene los datos de la division del nombre seleccionado.
			 		*/
		   			var nombreN:String = sss.pop();
		   			var apellidomN:String = sss.pop();
		   			var apellidopN:String = sss.pop();
		   			
		   			/**
		   			 * Compara los datos obtenidos de la division, con los que se 
		   			 * encuentran en el arreglo de clientes.
			 		*/
		   			for(i=0;i<largo;i++){
		   				var newCli:Cliente = cliente2.getItemAt(i,0) as Cliente;
		   				if(nombreN == newCli.nombre && apellidopN == newCli.apellido && apellidomN == newCli.apellido2){
		   					this.nombreRutIn.rutClienteInput.text=newCli.rut.substring(0,8);
		   					labelMessage.text = "Se ha accedido al cliente "+newCli.nombre+" "+newCli.apellido;
		   					sacaDigito();
		   					
		   					ini();
		   					
		   					
		   					break;
		   				}

		   			}
		   		}
		 
		   }
		   
		   
		   /**
		   	* Función para obtener el dígito verificador, y para guardarlo en 
		   	* el input dedicado a almacenar esa variable.
		   	 * @author  Raul Lopez
			*/
		   private function sacaDigito():void{        			
        			
        			var Numero:String = nombreRutIn.rutClienteInput.text;
					var suma:int = 0;
					var rut:String = Numero;
					var NumMag:int = 2;
					var Resto:int = 0;
					var j:int ;
					var i:int;
					var DigVer:Array = new Array("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "K", "0");
					var ParteNumerica:Array = new Array();
					if (rut.length == 0) { 

					}
					for ( j =0, i =0; j < rut.length; j++){
						if (rut.charAt(j) != ' ' && rut.charAt(j) != '.' && rut.charAt(j) != '-'){
							ParteNumerica[i] = rut.charAt(i);
							++i;
						}
					}
				
					for (i=ParteNumerica.length-1; i>=0; i--, NumMag++){
						suma += ParteNumerica[i] * NumMag;
						trace(suma +' '+ ParteNumerica[i] +' '+ NumMag);
						if (NumMag>6){
							NumMag =1;	
						}	
					}
					
					Resto = 11-(suma%11);
					if(Resto == 10){
						this.nombreRutIn.rutClienteDVInput.text="K";	
					}
					else{
						this.nombreRutIn.rutClienteDVInput.text=""+Resto;	
					}
					
        		
     		}
     		
     		     		
     		public function cancela():void{
     		
     		   this.visible = false;
     		   this.reset();
     		   Application.application.panelClinicaPrincipal.setVisible(true,false);
     		}
     		
     		public function mira():void{
     			if(Tabla.selectedItem){
     		  		
     		  		var editPel:EditarPeluqueriaUpdate = Application.application.editaPelUPdate;
     		  		editPel.iniciarPanel();
     		  		var itm:int = Tabla.selectedIndex;
     		  		var listCont2:Array = new Array();
     		  		listCont2 = Tabla.selectedItem.nombreMascota.split(" ",1);
					var nombre:String = listCont2.pop();
					editPel.nombreMascota=nombre;
					editPel.nombMasc.text=nombre;
					editPel.clienteRut=this.nombreRutIn.rutClienteInput.text;
					editPel.clienteRut2=this.nombreRutIn.rutClienteDVInput.text;
									
					var i:int;
					var large:int = listCatP.length;			
					for(i=0;i<large;i++){
						var tipoPel:CatPeluqueria = this.listCatP.getItemAt(i,0) as CatPeluqueria;
						var text2:String = tipoPel.nombre;

						editPel.tiposServ1.push(text2);
					}
					
					var s:String = Tabla.selectedItem.responsable.split(" ",1).pop();
					var k:int;
					var klarge:int = peluqueros.length;
					
					for(k=0;k<klarge;k++){
						var user:Usuario = peluqueros.getItemAt(k,0) as Usuario;
						
						if(s==user.usuario.split(" ",1).pop()){
							var sUsr:String = user.nombre.split(" ",1).pop();
							var sUsr2:String = user.apellidoPaterno.split(" ",1).pop();
							
							var sConcat:String = sUsr.concat(" "+sUsr2);
							editPel.veterinariosC.text = sConcat;
						}
					}
					var dat:Date   = Tabla.selectedItem.fecha;
					var hor:String = Tabla.selectedItem.hora;
					editPel.fechaAntigua= dat;
					editPel.hora = Tabla.selectedItem.hora;
					editPel.llenarTablaServiciosAnteriores(s,dat,hor);
					//Alert.show("hora: "+editPel.hora+".");
					this.visible = false;
     		  		editPel.setVisible(true,false);
     				
     			}
     			
     		}
     		
     		public function getResp():void{
     			
				var adpel:AddPeluqueriaService = new AddPeluqueriaService();
				adpel.addEventListener(ResultEvent.RESULT,getRespResult);
				adpel.getResponsable();
     		}
     		
     		public function getRespResult(event:ResultEvent):void{
     			peluqueros = event.result as ArrayCollection;
     		}
     		
     		public function reset():void{
     			peluquerias = new ArrayCollection();
     			nombreRutIn.inputClienteNombre.text = "";
     		    nombreRutIn.rutClienteInput.text = "";
     		    nombreRutIn.rutClienteDVInput.text = "";
     		}
     		
     		/**
		   	* Metodo que quita el focus al rut o al nombre.
		 	 * 	@author  "Raul Lopez"
			*/
     		private function focusSale():void
     		{
     			Tabla.setFocus();

     		}
     		
				
        ]]>
    </mx:Script>
	<mx:Label x="176" y="399" width="407" height="17" id="labelMessage" textAlign="center" fontWeight="bold"/>
	<mx:Label x="25" y="10" text="Cliente:" width="84.75" fontWeight="bold"/>
	<ns1:BuscadorNombreRut x="25" y="36" id="nombreRutIn">
	</ns1:BuscadorNombreRut>
	<mx:ComboBox id="dg2" x="90" y="85" width="177" dataProvider="{mascotas}" labelField="nombre" close="{busca()}" focusIn="getMascotas()"></mx:ComboBox>
	
	<mx:DataGrid x="25" y="158" width="710" id="Tabla" enabled="true" height="178" dataProvider="{peluquerias}" itemDoubleClick="{mira()}">
		<mx:columns>
			<mx:DataGridColumn headerText="Nombre mascota" dataField="nombreMascota" visible="false"/>
			<mx:DataGridColumn headerText="Rut" dataField="rutCliente" visible="false"/>
			<mx:DataGridColumn headerText="Responsable" dataField="responsable"/>
			<mx:DataGridColumn headerText="Fecha" dataField="fechaS"/>
			<mx:DataGridColumn headerText="Fechareal" dataField="fechaAntigua" visible="false"/>
			<mx:DataGridColumn headerText="Hora" dataField="hora"/>
			
		</mx:columns>
	</mx:DataGrid>
	<mx:Button x="632" y="353" label="Cancelar" width="103" id="cancelar" visible="true" height="23" click=" cancela()"/>
	<mx:Label x="25" y="136" text="Registros:" width="112.75" fontWeight="bold"/>
	<mx:Label x="25" y="64" text="Mascotas:" fontWeight="bold" width="67"/>
	<mx:Label x="25" y="87" text="Nombre:" width="55.75"/>
	
	<mx:Button x="522" y="353" label="Visualizar" width="103" id="cancelar0" visible="true" height="23" click="{ mira()}"/>
	
	
</mx:Panel>
