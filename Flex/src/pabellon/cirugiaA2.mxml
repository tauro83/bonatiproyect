<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml" click="key()" layout="absolute" width="779" height="466" borderColor="#15ad8f" title="Anular Cirugía">
	<mx:Script>
		<![CDATA[
		//=======================================================================
		// FECHA CREACIÓN: 14-10-09
		// AUTOR: Esteban Cruz
		// Comentario: Una vez seleccionado un cliente, se visualiza su información 
		// detalla junto a sus cirugias para poder anular la deseada
		//=======================================================================
				
			import mx.controls.Alert;
			import mx.collections.ArrayCollection;
            import mx.controls.CheckBox;    
            import mx.events.CloseEvent;
            import mx.rpc.events.ResultEvent;
            import mx.core.Application;
			
			import transferObjects.Cirugia;
			import services.CirugiaService;
			[Bindable]
			private var cirugias:ArrayCollection;
			
			private function key():void
			{
				Application.application.cirugiaA2.addEventListener(KeyboardEvent.KEY_DOWN,checkKey);
			}
 			private function checkKey(event:KeyboardEvent):void
            {
               if(event.charCode==13 && boton.enabled==true){
               		deleteRow();
               }
            }
			
			/**
			 * Evento del boton "Volver", el cual redirige la página
			 * a anterior (listado de clientes con cirugias acitadas)
			 * @author  "Esteban Cruz"
			 */
			public function actionVolver():void
			{
            	Application.application.cirugiaA2.setVisible(false,false);
            	Application.application.cirugiaA.setVisible(true,false);
            	motivo.text="";
            	comboboxMotivo.selectedIndex=0;
            	barraMsj.text="";
			}
			
			/**
			 * Se obtienen todas las cirugias que están registradas en 
			 * la base de datos para ser mostrados dentro del datagrid
			 * @author  "Esteban Cruz"
			 */
			public function getAllCirugiasU(rut:String, nombre:String):void
		    {
		   		var cirugiaService:CirugiaService = new CirugiaService();
		   		cirugiaService.addEventListener(ResultEvent.RESULT,getAllCirugiasResult);
				cirugiaService.getAllCirugiasU(rut, nombre);
		    }
		   
		    /**
			 * Una vez obtenidas todas las cirugias que están registradas 
			 * en la base de datos, son mostrados dentro del datagrid
			 * @author  "Esteban Cruz"
			 */
		    public function getAllCirugiasResult(event:ResultEvent):void
		    {
		   		cirugias = event.result as ArrayCollection;
		    }
			
			/**
			 * Se anulan las cirugias que están seleccionadas en el
			 * grid, desde la base de datos
			 * @author  "Esteban Cruz"
			 */
			public function anularCirugia(nombre:String, fecha:String, hora:String, motivo:String):void
			{
				var cirugiaService:CirugiaService = new CirugiaService();
				cirugiaService.anularCirugia(nombre, fecha, hora, motivo);
			}

            /**
			 * Mensaje para anular las cirugias que están seleccionadas
			 * en el grid, desde este mismo
			 * @author  "Esteban Cruz"
			 */
           	private function deleteRow():void 
           	{
           		if(comboboxMotivo.selectedLabel=='Otros'){
           			if(motivo.text!=""){
           				Alert.show("¿Está seguro que desea anular la(s) cirugía(s)? ","Confirme anulación ", Alert.YES | Alert.NO, this, delRowHandler, null, Alert.NO);
           			}
           			else{
           				Alert.show("Debe ingresar un motivo para anular la cirugía","Campo incompleto");
           			}
           		}
           		if(comboboxMotivo.selectedIndex==1 || comboboxMotivo.selectedIndex==2){
         			Alert.show("¿Está seguro que desea anular la(s) cirugía(s)? ","Confirme anulación ", Alert.YES | Alert.NO, this, delRowHandler, null, Alert.NO);
         		}
         		if(comboboxMotivo.selectedIndex==0){
         			Alert.show("Debe seleccionar un motivo para anular la cirugía","Campo incompleto");
         		}
			}
			
			/**
			 * Se anulan las cirugias que están seleccionadas en el
			 * grid, desde este mismo
			 * @author  "Esteban Cruz"
			 */
			private function removeTaskRecord():void
            {
                var allRows:int = cirugias.length;
                var ciru:Cirugia = new Cirugia();
                var motiv:String = "";
                boton.enabled=false;
                
	            if(comboboxMotivo.selectedLabel=='Otros'){
	                motiv = motivo.text;
	            }
	            else{
	            	motiv = comboboxMotivo.text;
	            }
                
                for (var i:int = 0; i < allRows; i++){
                    if (cirugias[i].sel)
                	{
                        ciru = cirugias[i] as Cirugia;
                        anularCirugia(ciru.mascotaNombre,ciru.fecha,ciru.hora,motiv);
                        
                        var elimItem:CirugiaService = new CirugiaService();
                        elimItem.regBit(ciru.mascotaNombre,ciru.clienteRut,ciru.hora,
                        Application.application.login2.usuarioActivo+" "+motiv);
                        
                        cirugias.removeItemAt(i);
                        allRows = cirugias.length;
                        tablaCirugias.dataProvider = cirugias;
                        i=-1;
                    }   
                }
                motivo.text="";
                barraMsj.text="Cirugía(s) anulada(s)";              
            }
			
			/**
			 * Una vez seleccionado SÍ o NO en el mensaje
			 * se llama a la función que anula
			 * @author  "Esteban Cruz"
			 */
			private function delRowHandler(evt:CloseEvent):void {
			    if ((evt.detail == Alert.NO) || (evt.detail == Alert.CANCEL)) return;
			  removeTaskRecord();
			}
			
			/**
			 * Se toma el objeto cliente con sus respectivos 
			 * datos, y se insertan en los campos correspondientes
			 * Cliente y Mascota
			 * @author  "Esteban Cruz"
			 */
			public function setDatos(ciru:Cirugia):void
			{
				getAllCirugiasU(ciru.clienteRut, ciru.mascotaNombre);
         		cNom.text=ciru.clienteNombre;
         		cRut.text=ciru.clienteRut;
         		cApP.text=ciru.clienteApellido;
         		mNom.text=ciru.mascotaNombre;
         		mRaz.text=ciru.mascotaRaza;
         		mSex.text=ciru.mascotaSexo;
         	}
         	
         	/**
			 * Se seleccionan todas las cirugias existentes
			 * en el grid
			 * @author  "Esteban Cruz"
			 */
         	private function selectAll():void{
                var allRows:int = cirugias.length;
                var bandera:int=1;
                for (var i:int = 0; i < allRows; i++){
                    if (todo.selected){
                        cirugias[i].sel = true;
                        boton.enabled=true;
                        bandera=0;
                    }
                    else{
                        cirugias[i].sel = false;
                        if(bandera!=0){
                        	boton.enabled=false;
                        }
                    }
                }
                tablaCirugias.dataProvider = cirugias;
            }
            
            private function Activar():void{
            	var allRows:int = cirugias.length;
            	var seleccion:Boolean=false;

            	for (var i:int = 0; i < allRows; i++){
            		if(cirugias[i].sel){
            			seleccion=true;
            		}
            	}
            	if(seleccion==true){
            		boton.enabled=true;
            	}
            	else{
            		boton.enabled=false;
            	}
            }
            
            private function seleccionarMotivo (event:Event):void
            {   
            	if(comboboxMotivo.selectedLabel=='Otros')
				{
					motivo.visible=true;
				}
				else
				{
					motivo.visible=false;
					motivo.text="";
				}
           	}
		]]>
	</mx:Script>
	
	<!-- Tabla con datos -->
	<mx:DataGrid click="Activar()" x="25" y="178" width="709" height="134" id="tablaCirugias" dataProvider="{cirugias}" toolTip="Seleccion la(s) cirugia(s) que desea anular">
		<mx:columns>
			<mx:DataGridColumn width="20" headerText="" dataField="checkbox" id="checkbox" draggable="false">
			 	<mx:itemRenderer>
                        <mx:Component>
                            <mx:CheckBox click="data.sel=!data.sel"  selected="{data.sel}"/>            
                        </mx:Component>
             	</mx:itemRenderer>
            </mx:DataGridColumn>
			<mx:DataGridColumn width="180" headerText="Veterinario" dataField="veterinario" draggable="false"/>
			<mx:DataGridColumn width="181" headerText="Ayudante" dataField="ayudante" draggable="false"/>
			<mx:DataGridColumn width="140" headerText="Servicio" dataField="servicio" draggable="false"/>
			<mx:DataGridColumn width="109" headerText="Hora" dataField="hora" draggable="false"/>
			<mx:DataGridColumn width="109" headerText="Fecha" dataField="fecha" draggable="false"/>
		</mx:columns>
	</mx:DataGrid>
	<mx:CheckBox x="25" y="152" id="todo" click="{selectAll()}" toolTip="Selecciona o deselecciona todo"/>
	<mx:Label x="47" y="152" text="Seleccionar todo"/>
	
	<!-- Elementos -->
	<mx:Button x="632" y="353" label="Volver" id="volver" toolTip="Vuelve al panel anterior" width="102" height="23" cornerRadius="6" click="actionVolver()"/>
	<mx:Label x="25" y="35" text="Nombre:" width="78"/>
	<mx:Label x="25" y="10" text="Cliente" width="97" fontWeight="bold"/>
	<mx:Label x="405" y="10" text="Mascota" width="98" fontWeight="bold"/>
	<mx:Label x="25" y="87.95" text="Rut:" width="78"/>
	<mx:Label x="405" y="87.95" text="Sexo:" width="78"/>
	<mx:Label x="405" y="36" text="Nombre:" width="63.4" height="17.931034"/>
	<mx:Label x="25" y="62" text="Apellido Paterno:" width="103"/>
	<mx:Label x="405" y="61.9" text="Raza:" width="78"/>
	<mx:Text x="25" y="124" text="Cirugías&#xa;" fontWeight="bold" height="20"/>
	<mx:Text x="136" y="62" id="cApP" width="150"/>
	<mx:Text x="136" y="35" id="cNom" width="150"/>
	<mx:Text x="136" y="87.95" id="cRut" width="150"/>
	<mx:Text x="478.4" y="36" id="mNom" width="150"/>
	<mx:Text x="478.4" y="61.9" id="mRaz" width="150"/>
	<mx:Text x="478.4" y="87.95" id="mSex" width="150"/>
	<mx:Button enabled="false" x="522" y="354" label="Anular" click="{deleteRow()}" cornerRadius="6" width="102" toolTip="Anula la(s) cirugia(s) seleccionada(s)" id="boton"/>
	<mx:TextInput x="244" y="320" width="490" id="motivo" visible="false" toolTip="Ingrese el motivo por el cual desea anular la(s) cirugia(s)"/>
	<mx:Text x="25" y="322" text="Motivo" fontWeight="bold"/>
	<mx:Label width="407" height="17" id="barraMsj" textAlign="center" fontWeight="bold" x="176" y="399"/>
	<mx:ComboBox x="76" y="320" id="comboboxMotivo" change="seleccionarMotivo(event)">
		<mx:ArrayCollection>
			<mx:Object label="-Seleccionar-"/>
			<mx:Object label="Registro incorrecto"/>
			<mx:Object label="Registro indeseado "/>
			<mx:Object label="Otros"/> 
		</mx:ArrayCollection>
	</mx:ComboBox>
	
</mx:Panel>
