<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="779" height="466" borderColor="#15AD8F" title="Registrar Vacunación" xmlns:ns1="*">
	<mx:Script>
        <![CDATA[
        	import mx.events.CalendarLayoutChangeEvent;
        	import transferObjects.Vacunacion;
        	import mx.collections.Sort;
        	import transferObjects.tiposCir;
        	import services.AddMascotaService;
        	import mx.controls.DateField;
        	import mx.controls.Alert;
            import mx.collections.ArrayCollection;
        	import mx.controls.Alert;
			import mx.events.CloseEvent;
			import mx.events.ValidationResultEvent;            
  			import flash.display.Sprite;
		    import flash.events.*;
		    import flash.net.FileReference;
		    import flash.net.FileReferenceList;
		    import mx.rpc.events.ResultEvent;
			
			import mx.controls.Image;
		    import transferObjects.Cirugia;
		    import mx.core.Application;
		    
		    import transferObjects.Person;
		    import pabellon.addCirugia;
		    import pabellon.addCirugia1;
		    import pabellon.AddCirugiaService;
		    
		   
			[Bindable]
			public var clienteRut:String;
			[Bindable]
			public var clienteRut2:String;
			[Bindable]
			public var nombreMascota:String;
			[Bindable]
			public var hora:String;
			[Bindable]
			public var veterinarios2:ArrayCollection;
			[Bindable]
			public var ayudantes2:ArrayCollection;
			[Bindable]
			public var ayudantes3:ArrayCollection;
			[Bindable]
			public var tiposVac1:Array;
			[Bindable]
			public var tiposCir2:Array;
			[Bindable]
			public var vacunasAdds:Array;
		   	private var fechaActual:Date = new Date();
		   	[Bindable]
		   	public var vacunass:ArrayCollection = new ArrayCollection();
		   
		   /**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  27 Octubre
			 *  @Descripcion Metodo que realiza la accion de volver al panel anterior, dejando invisible este
			 * y dejando visible el anterior.		 		
			 * */ 
		    public function vuelve():void
		    {
		    	this.setVisible(false,false);
		    	Application.application.addVacuna1.labelMessage.text="";
		    	Application.application.addVacuna1.iniciarPanel1();
		    	Application.application.addVacuna1.setVisible(true,false);
		    }
		    
		    /**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  27 Octubre
			 *  @Descripcion Metodo que realiza la accion de verificar que todos los datos esten correctamente
			 * ingresados en los inputs correspondientes, para que no se guarde una cirugia con datos erroneos.
			 * En caso de que se produsca algun error o que falten datos se mostrara por pantalla los mensajes 
			 * informando de cuales datos faltan por ingresar.		 		
			 * */ 
		    public function registrarVacuna():void{
		    	
		    	if(this.veterinariosC.text==""){
		    		this.labelMessage.text="Seleccione el nombre de un Veterinario para la vacunación.";
		    	}
		    	else{
		    		if(this.fechahoy.text==""){
		    			this.labelMessage.text="Seleccione una fecha para la vacunación.";
		    		}
		    		else{
		    			if(this.vacunasAdds.length==0){
		    				this.labelMessage.text="Añada un tipo de vacuna que se haya aplicado a la mascota.";
		    			}
		    			else{
		    				if(this.fechaC.text==""){
								this.labelMessage.text="Seleccione una fecha de caducidad para la vacunación.";
							}
							else{
								if(fechaC.selectedDate.getTime()<fechaActual.getTime()){
									this.labelMessage.text = "Ingrese una fecha de caducidad posterior a la actual";
								}
								else{
									this.labelMessage.text="";
		    						var newVacuna:Vacunacion = new Vacunacion();
		    	
		    						newVacuna.veterinario= this.veterinariosC.text;
		    						newVacuna.fechaCaducidad = this.fechaC.selectedDate;
		    						newVacuna.fecha = this.fechahoy.selectedDate;
		    						var i:int;
		    						var largo:int = this.vacunasAdds.length;
		    						newVacuna.tiposVacunas = new ArrayCollection();
		    						for(i=0;i<largo;i++){
		    							newVacuna.tiposVacunas.addItem(vacunasAdds.pop());
		    						}
		    						newVacuna.descripcion = this.descripcionV.text;	
		    						newVacuna.clienteRut = this.clienteRut.concat(this.clienteRut2);;
		    						newVacuna.mascotaNombre = this.nombreMascota;
		    						
		    						var newAddServ:AddVacunacionService = new AddVacunacionService();
		    						newAddServ.addVacuna(newVacuna);
		    						this.setVisible(false,false);
		    						Application.application.addVacuna1.iniciarPanel1();
		    						Application.application.addVacuna1.labelMessage.text="Vacunación Registrada con éxito.";
		    						Application.application.addVacuna1.setVisible(true,false);
								}	  
							}	
		    			}
		    					
		    		}
		    	}
		    	
		    	
		    }
		    
		    /**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  27 Octubre
			 *  @Descripcion Metodo que verifica que la fecha de caducidad sea posterior a la fecha actual.
			 * */
		    public function verificaFecha():void
		    {
		    	if(fechaC.selectedDate.getTime()<fechaActual.getTime()){
					labelMessage.text = "Ingrese una fecha de caducidad posterior a la actual"; 
				}
				else{
					labelMessage.text = "";
				}
				
		    	
		    }
		    
		    /**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  27 Octubre
			 *  @Descripcion Metodo que realiza la accion de quitar una cirugia de la lista de cirugias realizadas
			 * representada por la lista cirugsAdds y volviendo a colocarla disponible en la lista de cirugias.
			 * */ 
		     public function quitaVac():void
		    {
		    	
		    	if(vacunasList.selectedItem){
		    		this.labelMessage.text="";
		    		var s:String = vacunasList.selectedItem.toString();		    		
		    		tiposVac1.push(s);
		    		ordenar();
					renombrarVac2(s);
					
		    	}
		    	else{
		    		this.labelMessage.text="Seleccione una Vacuna de la tabla Vacunas Agregadas.";
		    	}
	
		    }
		    
		    /**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  27 Octubre
			 *  @Descripcion Metodo que realiza la accion de quitar una cirugia de la lista de cirugias realizadas
			 * representada por la lista cirugsAdds y volviendo a colocarla disponible en la lista de cirugias. 
			 * Esto lo hace comparando las cirugias con el nombre, y luego cuando encuentra la corecta la añade.
			 *  @Param String representando el nombre del tipo de cirugia.
			 * */ 
		    public function renombrarVac2(texto:String):void{
		    	var newAr:Array = this.vacunasAdds;
		    	vacunasAdds = new Array();
		    	var i:int;
		    	var j:int = newAr.length;
		    	for(i=0;i<j;i++){
		    		var s:String = newAr.pop();
		    		if(s!=texto){
		    			vacunasAdds.push(s);
		    		}
		    	}
		    	this.ordenar2();

		    	
		    }
		    
		    /**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  27 Octubre
			 *  @Descripcion Metodo que realiza la accion de agregar una cirugia de la lista de cirugias(tiposCir1) a la de 
			 * cirugias realizadas (cirugsAdds), representada por la lista cirugsAdds y volviendo a colocarla disponible en la lista de cirugias.
			 * */ 
		    public function guardaVac():void
		    {
		    	
		    	if(vacunas1.selectedItem){
		    		this.labelMessage.text="";
		    		var s:String = vacunas1.selectedItem.toString();		    		
		    		vacunasAdds.push(s);
		    		ordenar2();
					renombrarVac(s);
		    	}
		    	else{
		    		this.labelMessage.text="Seleccione una Vacuna de la lista Vacunas.";
		    	}
		    	
				
		    }
         
         
		    
         	
		    /**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  27 Octubre
			 *  @Descripcion Metodo que realiza la accion de agregar una cirugia de la lista de cirugias(tiposCir1) a la de 
			 * cirugias realizadas (cirugsAdds), representada por la lista cirugsAdds y volviendo a colocarla disponible en 
			 * la lista de cirugias. Esto lo hace comparando las cirugias con el nombre, y luego cuando encuentra la corecta la añade.
			 *  @Param String representando el nombre del tipo de cirugia.
			 * */ 
		    public function renombrarVac(texto:String):void{
		    	var newAr:Array = this.tiposVac1;
		    	tiposVac1 = new Array();
		    	var i:int;
		    	var j:int = newAr.length;
		    	for(i=0;i<j;i++){
		    		var s:String = newAr.pop();
		    		if(s!=texto){
		    			tiposVac1.push(s);
		    		}
		    	}
		    	this.ordenar();
		    	
            	

		    }
		    
		    /**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  27 Octubre
			 *  @Descripcion Metodo que procesa el orden que se mostrara en la lista de vacunas,
			 * tanto las agregadas, como las que se muestran para agregar.
			 * Se ordena por orden alfabetico.
			 * */ 
		    private function ordenLetra (a : Object , b : Object , fields : Array = null) : int
		    {

            	if (a > b)
            	{
               		return 1;
            	}
            	else if (a< b)
            	{
               		return -1;   
            	}
            	else {
               		return 0;
            	}
         	} 
		    
		    /**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  27 Octubre
			 *  @Descripcion Metodo que asigna la forma en que se ordenara la lista de las vacunas que 
			 * se reciben de la base de datos.
			 * */ 
		    private function ordenar () : void
         	{
           		var sort : Sort = new Sort ()
            	sort.compareFunction = ordenLetra;
            	vacunas1.dataProvider.sort = sort;
            	vacunas1.dataProvider.refresh ();
         	}
         	
         	 /**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  27 Octubre
			 *  @Descripcion Metodo que asigna la forma en que se ordenara la lista de las vacunas que 
			 * se han agregado.
			 * */ 
         	private function ordenar2 () : void
         	{
           		var sort : Sort = new Sort ()
            	sort.compareFunction = ordenLetra;
            	vacunasList.dataProvider.sort = sort;
            	vacunasList.dataProvider.refresh ();
         	}
         	
         	/**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  02 Noviembre
			 *  @Metodo que coloca una mascara en los numeros como los precios.
			 * */ 
         	public function makeNumberFormat (value : Object, separator : String):String{
				var str : Array = value.toString ().split ("");
				var i : Number = 0;
				var count : Number = 0
				var tmpArray : Array = []
				var back : String = ""
				str.reverse ();
				while (str [i]){
					if ((count % 4) == 0){
						tmpArray.push(separator);
					} 
					else{
						tmpArray.push(str [i]);
						i++;
					}
					count++;
				}
				tmpArray.reverse ();
				i = 0;
				while (tmpArray [i])
				{
					back += tmpArray [i];
					i++;
				}
				return back.substr (0, back.length - 1);
			} 
		    
		    
		    
		    
		   
		    /**
		 	 * 	@author  "Jimmy Muñoz"
			 * 	@Fecha  27 Octubre
			 *  @Descripcion Metodo que inicializa todos los datos del panel para que 
			 * no existan datos de registros anteriores.
			 * */ 
		    public function iniciarPanel():void
		    {
		    	this.labelMessage.text="";
		    	this.fechaC.text="";
		    	this.fechahoy.text="";
		    	this.vacunas1.doubleClickEnabled=true;
		    	this.tiposCir2 = new Array();
		    	this.tiposVac1 = new Array();
		    	this.ayudantes2 = new ArrayCollection();
		    	this.ayudantes3 = new ArrayCollection();
		    	this.veterinarios2 =new ArrayCollection();
		    	vacunass = new ArrayCollection();
		    	this.vacunasAdds =new Array();
		    	this.descripcionV.text="";


		    }
				
        ]]>
    </mx:Script>
	<mx:Label x="119.5" y="170" text="Vacunas:" width="63.4" height="17.931034"/>
	<mx:Label x="25" y="15" text="Responsable:" width="85.45"/>
	<mx:Label x="452" y="50" text="Caducidad:" width="77"/>
	<mx:Label x="176" y="399" width="407" height="17" id="labelMessage" textAlign="center" fontWeight="bold"/>
	
	<mx:ComboBox x="118.4" y="15" id="veterinariosC" dataProvider="{veterinarios2}" width="190.25"></mx:ComboBox>
	<mx:DateField x="540" y="15" width="122" id="fechahoy" formatString="DD/MM/YYYY"/>
	<mx:DateField x="540" y="50" width="122" id="fechaC" formatString="DD/MM/YYYY" change="verificaFecha()"/>
	<mx:TextArea x="119.5" y="50" width="271.6" height="112" id="descripcionV" maxChars="200">
	</mx:TextArea>
	<mx:TextInput x="540" y="85" width="104" id="nombMasc" editable="false"/>
	
	<mx:List x="119.5" y="195.9" width="270" height="149.1" id="vacunas1" dataProvider="{tiposVac1}"></mx:List>
	<mx:Button x="397.25" y="250" label="-&gt;" width="47.55" click="guardaVac()"/>
	<mx:Button x="397.25" y="280" label="&lt;-" width="47.55" click="quitaVac()"/>
	<mx:List x="452.8" y="195.9" width="282.65" height="149.1" id="vacunasList" dataProvider="{vacunasAdds}"></mx:List>
	
	<mx:Button x="522" y="353" label="Registrar" visible="true" id="registrar" click="registrarVacuna()" width="102" height="23"/>
	<mx:Button x="632" y="353" label="Cancelar" id="cancelar" visible="true" click="vuelve()" width="102" height="23"/>
	<mx:Label x="452" y="85" text="Mascota:" width="63.95"/>
	
	<mx:Label x="25" y="50" text="Descripción:" width="86"/>
	<mx:Label x="452" y="15" text="Fecha:" width="64.2"/>
	<mx:Label x="452" y="170" text="Cirugías agregadas:" width="137.4" height="17.931034"/>
	
	
	
	
	
</mx:Panel>