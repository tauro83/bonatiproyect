<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="779" height="466" borderColor="#15AD8F" title="Registro Cirugía">
	<mx:Script>
        <![CDATA[
        	import services.AddMascotaService;
        	import mx.controls.DateField;
        	import mx.controls.Alert;
            import mx.collections.ArrayCollection;
        	import mx.controls.Alert;
			import mx.events.CloseEvent;
			import mx.events.ValidationResultEvent;            
  			import flash.display.Sprite;
		    import flash.events.*;
		    import flash.net.FileReference;
		    import flash.net.FileReferenceList;
		    import mx.rpc.events.ResultEvent;
//			import components.ItemRenderer;
//			import events.FileUploaderEvent;
			import mx.controls.Image;
			import services.MascotaService;
		    import transferObjects.Mascota;
		    import services.PersonService;
		    import transferObjects.Person;
		    import mx.core.Application;
		   
			
			[Bindable]
			private var files:ArrayCollection=new ArrayCollection();
		    private var vResult:ValidationResultEvent;
		    
		    /**
			* Lista de amscotas del cliente asociado
			*/
		    [Bindable] 
		    public var mascotas:ArrayCollection = new ArrayCollection();
		    
		    [Bindable] 
		    public var cliente:Person;
		    
		    /**
			* Opciones de seleccion para sexo de la mascota
			*/
		    [Bindable]
            public var sexos:ArrayCollection = new ArrayCollection(
                [ {label:" ", data:0},
                  {label:"Macho", data:1}, 
                  {label:"Hembra", data:2} ]);    

			/**
			* Funcion que busca un cliente
			* @param event Evento
			*/
        	private function buscarCliente(event:Event):void{
        		ini(event);
        		var Numero:String = rutClienteInput.text;
        		var Dv:String = rutClienteDVInput.text;
				var suma:int = 0;
				var rut:String = Numero;
				var NumMag:int = 2;
				var Resto:int = 0;
				var j:int ;
				var i:int;
				var DigVer:Array = new Array("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "K", "0");
				var ParteNumerica:Array = new Array();
				
				if (rut.length == 0) { 
					//return false; 
					}
				for ( j =0, i =0; j < rut.length; j++){
					if (rut.charAt(j) != ' ' && rut.charAt(j) != '.' && rut.charAt(j) != '-'){
						ParteNumerica[i] = rut.charAt(i);
						++i;
					}
				}
				
				for (i=ParteNumerica.length-1; i>=0; i--, NumMag++){
					suma += ParteNumerica[i] * NumMag;
					trace(suma +' '+ ParteNumerica[i] +' '+ NumMag);
					if (NumMag>6){
						NumMag =1;	
					}	
				}
				
				Resto = 11-(suma%11);
				if(DigVer[Resto] != Dv.toUpperCase()){
					//rutClienteInput.errorString = "Rut Incorrecto";
					labelMessage.text = "El Rut que ha ingresado es incorrecto.";
					datosMascota.visible = false;
				}
				else{
					labelMessage.text = "";
					//Alert.show("Busco "+rutClienteInput.text);
					rutClienteInput.errorString = "";
					//getPerson(rutClienteInput.text);
					getCliente(rutClienteInput.text);
				}		
        	}
        	
			/**
			* Funcion que llena la tabla de mascotas asociadas al cliente
			* @param event Evento
			*/
	        private function ini(event:Event):void{
	        	datosMascota.visible = true;
	        	
	           	mascotas.removeAll();
	           	getMascotas();
				mascotas.refresh();
	         }

        	private function alertClickHandler(event:CloseEvent):void {
            	if (event.detail==Alert.YES)
                	rutClienteInput.visible=false;
            	else
                	rutClienteInput.visible=true;
        	}
        	
        	/**
			* Funcion que llena las opciones de razas segun la clase de animal seleccionada
			* @param event Evento
			*/
        	private function selRazas(event:Event):void {
        		var razas:ArrayCollection = new ArrayCollection();
    			
			}
			
						
			/**
			* Funcion escucha para agregar mascota
			* @param event Evento
			*/
			private function resultHandler(event:ResultEvent):void{
				var message:String= event.result as String;
				Alert.show(message);
			}
			
			
			/**
			* Funcion que llama  a retornar todas las mascotas 
			* 
			*/
			private function getAllMascotas():void{
				var mascotaService:MascotaService = new MascotaService();
				mascotaService.addEventListener(ResultEvent.RESULT,getAllMascotasResult);
				mascotaService.getAllMascotas();
			}
			
			/**
			* Funcion que obtiene todas las mascotas anteriormente llamadas
			* @param event Evento
			*/
			private function getAllMascotasResult(event:ResultEvent):void{
				mascotas = event.result as ArrayCollection;
				mascotas.refresh();
			}
			
			/**
			* Funcion que llama a retornar todas las mascotas de un cliente
			*/
			private function getMascotas():void{
				var addMascotaService:AddMascotaService = new AddMascotaService();
				addMascotaService.addEventListener(ResultEvent.RESULT,getAddMascotasResult);
				addMascotaService.getMascotas(rutClienteInput.text);
			}
			
			/**
			* Funcion que obtiene todas las mascotas de un cliente
			* @param event Evento
			*/
			private function getAddMascotasResult(event:ResultEvent):void{
				mascotas = event.result as ArrayCollection;
				mascotas.refresh();
			}
			
			/**
			* Funcion que llama para retornar todos los clientes
			* @param event Evento
			*/
			/*private function getPerson(rutCliente:String):void{
				var personService:PersonService = new PersonService();
				personService.addEventListener(ResultEvent.RESULT,getPersonResult);
//				personService.getPerson(rutCliente);
			}*/
			
			private function getCliente(rutCliente:String):void{
				var addMascotaService: AddMascotaService = new AddMascotaService();
				addMascotaService.addEventListener(ResultEvent.RESULT,getClienteResult);
				addMascotaService.getCliente(rutCliente);
			}
			
			/**
			* Aquí van los comentarios del método
			* @param event Evento
			*/
			/*private function getPersonResult(event:ResultEvent):void{
				cliente = event.result as Person;
				
				if(cliente == null){
        			Alert.show("Cliente no registrado!");
        			datosMascota.visible = false;
        		}
        		else{
        			//datosMascota.visible = true;
        			//rutClienteOutput.text = cliente.rut;
        			//nombreClienteOutput.text = cliente.name;
        			//apellidoClienteOutput.text = cliente.lastName;
        			ini(event);
        		}
			}*/

			private function getClienteResult(event:ResultEvent):void{
				var nombreCliente:String = event.result as String;
				
				if(nombreCliente == null){
        			//Alert.show("Cliente no registrado!");
        			labelMessage.text = "Cliente no registrado."
        			datosMascota.visible = false;
        			Application.application.AdmIngreso2.setVisible(true);
        			Application.application.AdmIngreso2.labelMessage.text = "El cliente ingresado no esta registrado."
        			Application.application.AdmIngreso2.rut.text = rutClienteInput.text;
        			Application.application.AdmIngreso2.rut2.text = rutClienteDVInput.text;
        			this.setVisible(false);
        			dg.visible = true;
        			
        			ini(event);
        		}
        		else{
        			datosMascota.visible = true;
        			labelMessage.text = "Se ha accedido al cliente " + nombreCliente + " satisfactoriamente.";
        			ini(event);
        			dg.visible = true;
        		}
			}
			
						
			private function borrarTodo(){

			}	
        ]]>
    </mx:Script>
	
	<!-- DATOS BUSQUEDA DE CLIENTE PARA REGISTRO DE MASCOTA --> 
	
	<mx:Label x="38.75" y="38" text="Rut:" width="84"/>
	<mx:Label x="242" y="38" text="-" width="14.75" textAlign="center"/>
	<mx:TextInput  restrict="0-9" x="153.5" y="36" width="90.5" id="rutClienteInput" maxChars="9" change="rutClienteDVInput.enabled=true"/>
	<mx:TextInput x="253.5" y="36" width="19.5" id="rutClienteDVInput" maxChars="1" restrict="K k 0-9" focusOut="buscarCliente(event)"/>
	
	<!-- BOTON QUE DA ACCION A BUSQUEDA DE CLIENTE -->

	<!-- FICHA DE MASCOTA SELECCIONADA --> 
	<mx:Panel x="121.5" y="-12" width="585" height="323" layout="absolute"  visible="false" id="ficha">
			<mx:Label x="10" y="63" text="Nombre:" width="97"/>
			<mx:Label x="10" y="125" text="Tipo Animal:" width="97"/>
			<mx:Label x="10" y="95" text="Fecha Nacimiento:" width="114.5"/>
			<mx:Label x="10" y="155" text="Raza:" width="97"/>
			<mx:Label x="10" y="181" text="Sexo:" width="97"/>
			<mx:Label x="172" y="10" width="211" text="{dg.selectedItem.rut}" textAlign="center" id="rutClienteSeleccionado"/>
			<mx:Label x="172" y="23" width="211" text="{dg.selectedItem.nombre}" textAlign="center"/>
			<mx:Image x="343" y="61" source="{dg.selectedItem.imagenMascota}" width="209" height="157" id="fichaImagen"/>
			<mx:Button x="501" y="245" label="Salir" click="ficha.visible=false"/>
			<mx:Label x="129" y="63" width="165" text="{dg.selectedItem.nombreMascota}"/>
			<mx:Label x="129" y="95" width="165" text="{dg.selectedItem.fechaNacimiento}"/>
			<mx:Label x="129" y="125" width="165" text="{dg.selectedItem.tipoAnimal}"/>
			<mx:Label x="129" y="155" width="165" text="{dg.selectedItem.raza}"/>
			<mx:Label x="129" y="181" width="165" text="{dg.selectedItem.sexo}"/>
	</mx:Panel>	
			
	<mx:Canvas x="38.75" y="64" width="681.5" height="247" id="datosMascota" visible="true">
		
		<!-- DATOS DE REGISTRO DE MASCOTA --> 
		<!-- DATOS DE CLIENTE SELECCIONADO --> 
		
		 <!-- TABLA DE MASCOTAS DEL CLIENTE --> 
		<mx:DataGrid id="dg" color="0x323232" width="681" rowCount="3" y="10" x="0" variableRowHeight="true" dataProvider="{mascotas}"  visible="false" height="103">
		    <mx:columns>
		        <mx:DataGridColumn dataField="nombre" headerText="Nombre" editable="true" width="100"/>
		        <mx:DataGridColumn dataField="fechaNacimiento" headerText="F. Nacimiento" width="100"/>
		        <mx:DataGridColumn dataField="claseAnimal" headerText="Clase Animal" width="100"/>
		        <mx:DataGridColumn dataField="raza" headerText="Raza" width="150"/>
		        <mx:DataGridColumn dataField="sexo" headerText="Sexo" width="95"/>
		        <mx:DataGridColumn dataField="imagen" headerText="Imagen">
		        	<mx:itemRenderer>
	        			<mx:Component>
	        		    	<mx:Image width="15" height="15" horizontalAlign="center"/>
	        			</mx:Component>
		        	</mx:itemRenderer>
		        </mx:DataGridColumn> 
		    </mx:columns>
		</mx:DataGrid>
		
		<!-- BOTONES --> 
		
		<!-- OPCIONES PARA SUBIR IMAGEN -->
	</mx:Canvas>
	<!--
	<ns1:FileUploader x="465.75" y="152" uploaded="uploadedHandler(event)" width="200.5">
	</ns1:FileUploader>
	-->
	<mx:Button x="546.25" y="328" label="Registrar" visible="true" id="registrar"/>
	<mx:Button x="636.25" y="328" label="Cancelar" width="84" id="cancelar" visible="true"/>
	<mx:Label x="169" y="372" width="407" height="17" id="labelMessage" textAlign="center" fontWeight="bold"/>
	<mx:Label x="10" y="10" text="Datos del cliente:" width="112.75" fontWeight="bold"/>
	<!--
	<mx:TileList x="465.75" y="9" width="200.5" height="135" dataProvider="{files}" itemRenderer="components.ItemRenderer"></mx:TileList>
	-->	
</mx:Panel>
